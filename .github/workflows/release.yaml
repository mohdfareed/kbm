name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  ci:
    uses: ./.github/workflows/ci.yaml

  versioning:
    name: Bump Version
    needs: ci
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-python: true
      - uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
      - run: uv sync --dev --locked

      - name: Bump version
        id: bump
        run: |
          uv version --bump ${{ inputs.bump }}
          VERSION=$(uv version | awk '{print $2}')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumped to $VERSION"

      - name: Commit & tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml uv.lock
          git commit -m "release: v${{ steps.bump.outputs.version }}"
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin HEAD:main --tags

  docker:
    name: Publish Docker Image
    needs: versioning
    runs-on: ubuntu-latest
    permissions:
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: v${{ needs.versioning.outputs.version }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=v${{ needs.versioning.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=v${{ needs.versioning.outputs.version }}
            type=semver,pattern={{major}},value=v${{ needs.versioning.outputs.version }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  github-release:
    name: GitHub Release
    needs: versioning
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: v${{ needs.versioning.outputs.version }}

      - name: Build release notes
        id: notes
        run: |
          {
            echo "body<<EOF"
            echo "## Installation"
            echo ""
            echo '```bash'
            echo "# Install from GitHub (requires git)"
            echo "pip install git+https://github.com/${{ github.repository }}.git@v${{ needs.versioning.outputs.version }}"
            echo '```'
            echo ""
            cat docs/cli.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.versioning.outputs.version }}
          generate_release_notes: true
          body: ${{ steps.notes.outputs.body }}
